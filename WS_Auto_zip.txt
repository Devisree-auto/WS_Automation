# === CONFIGURATION ===
$baseDir = "C:\Shared\Libs"
$completedDir = "C:\Shared\Completed"
$uaJar = "C:\Mend\unified-agent.jar"
$configFile = "C:\Mend\wss-unified-agent.config"

# === Ensure Completed Directory Exists ===
if (!(Test-Path -Path $completedDir)) {
    New-Item -ItemType Directory -Path $completedDir
}

# === Function to Recursively Extract ZIPs ===
function Extract-Zips-InFolder {
    param (
        [string]$targetFolder
    )

    $zipFiles = Get-ChildItem -Path $targetFolder -Recurse -Filter *.zip -ErrorAction SilentlyContinue

    while ($zipFiles.Count -gt 0) {
        foreach ($zip in $zipFiles) {
            $extractPath = Join-Path -Path $zip.Directory.FullName -ChildPath ($zip.BaseName + "_unzipped")
            try {
                Expand-Archive -Path $zip.FullName -DestinationPath $extractPath -Force
                Remove-Item -Path $zip.FullName -Force
                Write-Host "‚úÖ Extracted: $($zip.FullName)"
            } catch {
                Write-Host "‚ö†Ô∏è Failed to extract: $($zip.FullName)"
            }
        }
        $zipFiles = Get-ChildItem -Path $targetFolder -Recurse -Filter *.zip -ErrorAction SilentlyContinue
    }
}

# === Main Process ===
Get-ChildItem -Path $baseDir | ForEach-Object {
    $item = $_
    $itemName = $item.Name
    $itemPath = $item.FullName
    $workDir = ""

    # === Case 1: ZIP File ===
    if ($item.Extension -eq ".zip") {
        $extractedFolderName = [System.IO.Path]::GetFileNameWithoutExtension($itemName)
        $workDir = Join-Path -Path $baseDir -ChildPath $extractedFolderName
        Expand-Archive -Path $itemPath -DestinationPath $workDir -Force
        Write-Host "üì¶ Unzipped top-level zip: $itemName"
    }
    # === Case 2: Folder ===
    elseif ($item.PSIsContainer) {
        $workDir = $itemPath
        Write-Host "üìÅ Found folder: $itemName"
    }

    # === Process Extracted Content ===
    if (Test-Path $workDir) {
        Extract-Zips-InFolder -targetFolder $workDir

        # === Run Mend UA Scan ===
        Write-Host "üîç Scanning: $workDir"
        $scanCommand = "java -jar `"$uaJar`" -c `"$configFile`" -d `"$workDir`""
        Invoke-Expression $scanCommand

        if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ Scan successful. Moving to completed."

            # Move original ZIP if applicable
            if ($item.Extension -eq ".zip") {
                Move-Item -Path $itemPath -Destination "$completedDir\$itemName"

                $extractedFolderPath = Join-Path $baseDir ([System.IO.Path]::GetFileNameWithoutExtension($itemName))
                if (Test-Path $extractedFolderPath) {
                    Move-Item -Path $extractedFolderPath -Destination "$completedDir\"
                }
            }
            # Move folder if item was already a folder
            elseif ($item.PSIsContainer) {
                Move-Item -Path $itemPath -Destination "$completedDir\"
            }
        } else {
            Write-Host "‚ùå Scan failed for $itemName. Leaving in place."
        }
    }

    Write-Host "----------------------------------`n"
}

Write-Host "üèÅ All scans complete."
