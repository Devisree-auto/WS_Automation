# Configurable paths
$baseDir = "C:\Shared\Libs"
$completedDir = "C:\Shared\Completed"
$uaJar = "C:\Mend\unified-agent.jar"
$configFile = "C:\Mend\wss-unified-agent.config"

# Ensure completed folder exists
if (!(Test-Path -Path $completedDir)) {
    New-Item -ItemType Directory -Path $completedDir
}

# Function to recursively extract all ZIPs in a folder (in-place)
function Extract-Zips-InFolder {
    param (
        [string]$targetFolder
    )

    $zipFiles = Get-ChildItem -Path $targetFolder -Recurse -Filter *.zip -ErrorAction SilentlyContinue

    while ($zipFiles.Count -gt 0) {
        foreach ($zip in $zipFiles) {
            $extractPath = Join-Path -Path $zip.Directory.FullName -ChildPath ($zip.BaseName + "_unzipped")

            try {
                Expand-Archive -Path $zip.FullName -DestinationPath $extractPath -Force
                Remove-Item -Path $zip.FullName -Force
                Write-Host "‚úÖ Extracted: $($zip.FullName)"
            } catch {
                Write-Host "‚ö†Ô∏è Failed to extract: $($zip.FullName)"
            }
        }
        # Refresh list of ZIPs after extraction (in case of nested ones)
        $zipFiles = Get-ChildItem -Path $targetFolder -Recurse -Filter *.zip -ErrorAction SilentlyContinue
    }
}

# Main loop
Get-ChildItem -Path $baseDir | ForEach-Object {
    $item = $_
    $itemName = $item.Name
    $itemPath = $item.FullName
    $workDir = ""

    if ($item.Extension -eq ".zip") {
        # Expand top-level zip to its own folder (e.g., lib1.zip ‚Üí lib1)
        $workDir = Join-Path -Path $baseDir -ChildPath ([System.IO.Path]::GetFileNameWithoutExtension($itemName))
        Expand-Archive -Path $itemPath -DestinationPath $workDir -Force
        Write-Host "üì¶ Unzipped top-level zip: $itemName"
    }
    elseif ($item.PSIsContainer) {
        # It's a regular folder
        $workDir = $itemPath
        Write-Host "üìÅ Found folder: $itemName"
    }

    # Now recursively unzip any ZIPs inside the working folder
    if (Test-Path $workDir) {
        Extract-Zips-InFolder -targetFolder $workDir

        # Run Mend UA scan
        Write-Host "üîç Running scan for $workDir"
        $scanCommand = "java -jar `"$uaJar`" -c `"$configFile`" -d `"$workDir`""
        Invoke-Expression $scanCommand

        if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ Scan successful. Moving to completed."
            if ($item.Extension -eq ".zip") {
                Move-Item -Path $itemPath -Destination "$completedDir\$itemName"
            }
            Move-Item -Path $workDir -Destination "$completedDir\"
        } else {
            Write-Host "‚ùå Scan failed for $itemName. Leaving in place."
        }
    }

    Write-Host "----------------------------------`n"
}

Write-Host "üèÅ All scans complete."
