# === CONFIG ===
$baseDir = "C:\Shared\Libs"
$completedDir = "C:\Shared\Completed"
$uaJar = "C:\Mend\unified-agent.jar"
$configFile = "C:\Mend\wss-unified-agent.config"

# Ensure completed directory exists
if (!(Test-Path -Path $completedDir)) {
    New-Item -ItemType Directory -Path $completedDir
}

# === Function to recursively extract zip files ===
function Extract-Zips-InFolder {
    param (
        [string]$targetFolder
    )

    $zipFiles = Get-ChildItem -Path $targetFolder -Recurse -Filter *.zip -ErrorAction SilentlyContinue

    while ($zipFiles.Count -gt 0) {
        foreach ($zip in $zipFiles) {
            $extractPath = Join-Path -Path $zip.Directory.FullName -ChildPath ($zip.BaseName + "_unzipped")
            try {
                Expand-Archive -Path $zip.FullName -DestinationPath $extractPath -Force
                Remove-Item -Path $zip.FullName -Force
                Write-Host "‚úÖ Extracted: $($zip.FullName)"
            } catch {
                Write-Host "‚ö†Ô∏è Failed to extract: $($zip.FullName)"
            }
        }

        # Look again for new ZIPs after extracting
        $zipFiles = Get-ChildItem -Path $targetFolder -Recurse -Filter *.zip -ErrorAction SilentlyContinue
    }
}

# === Main Logic ===
Get-ChildItem -Path $baseDir -Directory | ForEach-Object {
    $folder = $_
    $folderName = $folder.Name
    $folderPath = $folder.FullName

    Write-Host "`nüìÅ Processing folder: $folderName"

    # Step 1: Extract all nested zips inside this folder
    Extract-Zips-InFolder -targetFolder $folderPath

    # Step 2: Run Mend UA scan
    Write-Host "üîç Scanning: $folderName"
    $scanCommand = "java -jar `"$uaJar`" -c `"$configFile`" -d `"$folderPath`""
    Invoke-Expression $scanCommand

    if ($LASTEXITCODE -eq 0) {
        Write-Host "‚úÖ Scan successful. Moving $folderName to completed."
        Move-Item -Path $folderPath -Destination (Join-Path $completedDir $folderName)
    } else {
        Write-Host "‚ùå Scan failed for $folderName. Leaving in place."
    }

    Write-Host "----------------------------------"
}

Write-Host "`nüèÅ All folder scans complete."
